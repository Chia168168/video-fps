<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>選擇影片並計算 FPS</title>
</head>
<body>
    <h2>選擇影片檔案並計算 FPS</h2>
    <input type="file" id="videoInput" accept="video/*">
    <br><br>
    <video id="videoPreview" width="640" height="360" controls style="display: none;">
        您的瀏覽器不支援 video 標籤。
    </video>
    <p>當前 FPS: <span id="fps">0</span></p>

    <script>
        const videoInput = document.getElementById('videoInput');
        const videoPreview = document.getElementById('videoPreview');
        const fpsDisplay = document.getElementById('fps');
        
        let frameCount = 0;
        let startTime = null;
        let animationId = null;

        // 選擇檔案事件
        videoInput.addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('video/')) {
                const url = URL.createObjectURL(file);
                videoPreview.src = url;
                videoPreview.style.display = 'block';
                videoPreview.load();
                
                // 等待載入完成後自動播放並開始計算 FPS
                videoPreview.addEventListener('loadedmetadata', () => {
                    videoPreview.play();
                });
            } else {
                alert('請選擇有效的影片檔案！');
            }
        });

        // 開始計算 FPS（使用 requestAnimationFrame）
        function startFPSCalculation() {
            frameCount = 0;
            startTime = performance.now();

            function calculateFPS(timestamp) {
                if (!startTime) startTime = timestamp;
                
                frameCount++;
                const elapsedTime = (timestamp - startTime) / 1000; // 轉為秒

                if (elapsedTime >= 1) { // 每秒更新一次 FPS
                    const fps = Math.round(frameCount / elapsedTime);
                    fpsDisplay.textContent = fps;
                    // 重置計數
                    frameCount = 0;
                    startTime = timestamp;
                }

                if (!videoPreview.paused && !videoPreview.ended) {
                    animationId = requestAnimationFrame(calculateFPS);
                }
            }

            animationId = requestAnimationFrame(calculateFPS);
        }

        // 影片開始播放時啟動 FPS 計算
        videoPreview.addEventListener('play', startFPSCalculation);

        // 暫停或結束時停止計算並清理
        videoPreview.addEventListener('pause', () => {
            fpsDisplay.textContent = '0';
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        });

        videoPreview.addEventListener('ended', () => {
            fpsDisplay.textContent = '0';
            if (animationId) {
                cancelAnimationFrame(animationId);
            }
        });

        // 清理資源
        videoPreview.addEventListener('loadeddata', () => {
            if (videoPreview.src) {
                URL.revokeObjectURL(videoPreview.src);
            }
        });
    </script>
</body>
</html>
