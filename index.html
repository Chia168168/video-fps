<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <title>選擇影片並獲取原始 FPS</title>
    <!-- 載入 MediaInfo.js，優先本地檔案，失敗則回退到 CDN -->
    <script src="video-fps/js/MediaInfoModule.js" onerror="this.src='https://cdn.jsdelivr.net/npm/mediainfo.js@0.2.1/dist/MediaInfoModule.min.js'"></script>
</head>
<body>
    <h2>選擇影片檔案並獲取原始 FPS</h2>
    <input type="file" id="videoInput" accept="video/*">
    <br><br>
    <video id="videoPreview" width="640" height="360" controls style="display: none;">
        您的瀏覽器不支援 video 標籤。
    </video>
    <p>原始 FPS: <span id="originalFps">0</span></p>
    <p>錯誤訊息: <span id="errorMsg">無</span></p>

    <script>
        const videoInput = document.getElementById('videoInput');
        const videoPreview = document.getElementById('videoPreview');
        const originalFpsDisplay = document.getElementById('originalFps');
        const errorMsgDisplay = document.getElementById('errorMsg');
        
        let mediaInfo = null;

        // 初始化 MediaInfo.js
        async function initMediaInfo() {
            try {
                mediaInfo = await MediaInfo({
                    locateFile: () => 'video-fps/wasm/MediaInfoModule.wasm' || 'https://cdn.jsdelivr.net/npm/mediainfo.js@0.2.1/dist/MediaInfo.wasm'
                });
                console.log('MediaInfo.js 已成功載入');
                errorMsgDisplay.textContent = 'MediaInfo.js 載入成功';
            } catch (error) {
                console.error('載入 MediaInfo.js 失敗:', error);
                errorMsgDisplay.textContent = 'MediaInfo.js 載入失敗 (請檢查檔案路徑或網路)';
                originalFpsDisplay.textContent = '無法解析';
            }
        }
        initMediaInfo();

        // 選擇檔案事件
        videoInput.addEventListener('change', async function(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('video/')) {
                // 限制檔案大小（100MB）
                if (file.size > 100 * 1024 * 1024) {
                    errorMsgDisplay.textContent = '檔案過大，請選擇小於 100MB 的影片';
                    return;
                }

                // 重置顯示
                originalFpsDisplay.textContent = '解析中...';
                errorMsgDisplay.textContent = '無';
                
                // 解析原始 FPS
                await parseOriginalFps(file);
                
                // 載入影片預覽
                const url = URL.createObjectURL(file);
                videoPreview.src = url;
                videoPreview.style.display = 'block';
                videoPreview.load();
                
                videoPreview.addEventListener('loadedmetadata', () => {
                    videoPreview.play().catch(err => {
                        console.error('自動播放失敗:', err);
                        errorMsgDisplay.textContent = '自動播放失敗 (請手動播放)';
                    });
                }, { once: true });
            } else {
                alert('請選擇有效的影片檔案！');
                errorMsgDisplay.textContent = '無效的檔案類型';
            }
        });

        // 解析原始 FPS
        async function parseOriginalFps(file) {
            if (!mediaInfo) {
                originalFpsDisplay.textContent = 'MediaInfo 未初始化';
                errorMsgDisplay.textContent = 'MediaInfo 未初始化，請檢查控制台';
                return;
            }
            
            try {
                const arrayBuffer = await file.arrayBuffer();
                const info = await mediaInfo.analyzeData(file.size, () => arrayBuffer);
                const json = JSON.parse(info);
                
                let fps = 0;
                if (json.media && json.media.track) {
                    for (const track of json.media.track) {
                        if (track['@type'] === 'Video' && track.FrameRate) {
                            fps = parseFloat(track.FrameRate);
                            break;
                        }
                    }
                }
                
                originalFpsDisplay.textContent = fps > 0 ? Math.round(fps) : '無法解析 FPS';
                if (fps === 0) {
                    errorMsgDisplay.textContent = '未找到影片軌道或 FPS 資訊';
                }
            } catch (error) {
                console.error('解析 FPS 失敗:', error);
                originalFpsDisplay.textContent = '解析錯誤';
                errorMsgDisplay.textContent = `解析錯誤: ${error.message}`;
            }
        }

        // 清理資源
        window.addEventListener('beforeunload', () => {
            if (videoPreview.src) URL.revokeObjectURL(videoPreview.src);
        });
    </script>
</body>
</html>
